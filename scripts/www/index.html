<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‰ºæ•°è”åŠ¨æ‰“å¡ç³»ç»Ÿ V8.0 (è®°å½•å¯åˆ ç‰ˆ)</title>
    <!-- å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥ localForage åº“ï¼Œç”¨äºè°ƒç”¨æµè§ˆå™¨åº•å±‚å¤§å®¹é‡æ•°æ®åº“ IndexedDB -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js"></script>
    <style>
        .day-btn { transition: all 0.2s ease; }
        ::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="bg-[#f5f7f5] font-sans min-h-screen text-gray-800 pb-10">

    <div class="max-w-md mx-auto bg-white min-h-screen shadow-lg sm:rounded-2xl sm:min-h-[800px] sm:mt-6 sm:overflow-hidden relative">
        
        <!-- é¡¶éƒ¨å¯¼èˆªæ¡ -->
        <div class="bg-[#eaf5ec] p-4 flex justify-between items-center sticky top-0 z-20">
            <h1 class="text-xl font-bold text-gray-800">è‰ºæ•°æ¸…å•2.0</h1>
            <div class="flex items-center gap-3">
                <div class="text-sm text-[#4caf50] font-semibold bg-[#dcfce7] px-3 py-1 rounded-full">å½“å‰ï¼š<span id="header-date"></span></div>
                <!-- ä¸€é”®æ¸…ç©ºæµ‹è¯•æ•°æ®æŒ‰é’® -->
                <button onclick="clearAllData()" class="text-xl text-gray-400 hover:text-red-500 transition-colors" title="æ¸…ç©ºæ‰€æœ‰æµ‹è¯•æ•°æ®">âš™ï¸</button>
            </div>
        </div>

        <!-- é¡µé¢åŠ è½½æ—¶çš„ Loading é®ç½© -->
        <div id="loading-screen" class="absolute inset-0 bg-white z-50 flex flex-col items-center justify-center">
            <div class="animate-spin rounded-full h-10 w-10 border-4 border-[#4caf50] border-t-transparent mb-3"></div>
            <p class="text-gray-500 text-sm">æ•°æ®åº“å‡çº§ä¸åŠ è½½ä¸­...</p>
        </div>

        <div class="p-5 space-y-6">
            
            <!-- æ¨¡å— 1ï¼šåˆ›å»ºä¹ æƒ¯ -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-5">
                <div class="mb-5 flex gap-2">
                    <input type="text" id="task-name" class="flex-1 bg-[#f8faf8] border border-gray-200 rounded-lg p-3 text-sm focus:outline-none focus:ring-2 focus:ring-[#4caf50]" placeholder="ä¾‹å¦‚æ—©èµ·ã€èƒŒå•è¯ç­‰">
                </div>
                <div class="mb-5">
                    <h3 class="text-sm font-bold text-gray-700 mb-3">ä¹ æƒ¯å‘¨æœŸ</h3>
                    <div class="flex gap-2 mb-3">
                        <span class="bg-[#eaf5ec] text-[#2e7d32] px-4 py-1.5 rounded-md text-sm font-bold cursor-pointer">æŒ‰å‘¨</span>
                        <span class="text-gray-400 px-4 py-1.5 rounded-md text-sm cursor-pointer">å›ºå®š/å…¶ä»–æš‚ä¸æ¼”ç¤º</span>
                    </div>
                    <div class="flex justify-between mt-4" id="week-days-container"></div>
                </div>
                <div class="mb-5 flex justify-between items-center border-t border-gray-50 pt-4">
                    <h3 class="text-sm font-bold text-gray-700">æ‰“å¡å¼€å§‹æ—¥æœŸ</h3>
                    <input type="date" id="start-date" class="text-sm text-gray-600 border-none outline-none bg-transparent text-right">
                </div>
                <button onclick="createTask()" class="w-full bg-[#4caf50] hover:bg-[#43a047] text-white font-bold py-3 px-4 rounded-full shadow-md transition-colors">
                    ä¿å­˜ä¹ æƒ¯ï¼Œå¼€å§‹æ‰§è¡Œ
                </button>
            </div>

            <!-- æ¨¡å— 2ï¼šå¾…åŠåŒº -->
            <div class="bg-[#fcfdfc] p-4 rounded-xl border border-gray-100 shadow-sm">
                <div class="flex items-center justify-between mb-4">
                    <button onclick="changeDate(-1)" class="w-8 h-8 flex items-center justify-center rounded-full bg-white shadow-sm text-gray-500 hover:text-[#4caf50] hover:bg-green-50">â—€</button>
                    <div class="text-center">
                        <h2 class="text-lg font-bold text-gray-800" id="view-date-title">ä»Šæ—¥å¾…åŠ</h2>
                        <span class="text-xs text-gray-400" id="view-date-subtitle"></span>
                    </div>
                    <button onclick="changeDate(1)" class="w-8 h-8 flex items-center justify-center rounded-full bg-white shadow-sm text-gray-500 hover:text-[#4caf50] hover:bg-green-50">â–¶</button>
                </div>
                <div id="today-tasks-list" class="space-y-3"></div>
            </div>

            <!-- æ¨¡å— 3ï¼šæ‰“å¡è®°å½•å¢™ -->
            <div class="bg-[#fcfdfc] p-4 rounded-xl border border-gray-100 shadow-sm">
                <div class="flex items-center justify-between mb-4">
                    <button onclick="changeHistoryDate(-1)" class="w-8 h-8 flex items-center justify-center rounded-full bg-white shadow-sm text-gray-500 hover:text-[#4caf50] hover:bg-green-50">â—€</button>
                    <div class="text-center">
                        <h2 class="text-lg font-bold text-gray-800" id="history-date-title">ä»Šæ—¥è®°å½•å¢™</h2>
                        <span class="text-xs text-gray-400" id="history-date-subtitle"></span>
                    </div>
                    <button onclick="changeHistoryDate(1)" class="w-8 h-8 flex items-center justify-center rounded-full bg-white shadow-sm text-gray-500 hover:text-[#4caf50] hover:bg-green-50">â–¶</button>
                </div>
                <div id="history-list" class="grid grid-cols-2 gap-3"></div>
            </div>
        </div>
    </div>

    <!-- æ‰“å¡å¼¹çª— -->
    <div id="checkin-modal" class="fixed inset-0 bg-black bg-opacity-40 hidden flex justify-center items-end sm:items-center z-50">
        <div class="bg-white p-6 rounded-t-2xl sm:rounded-2xl shadow-xl w-full sm:w-96 transform transition-transform">
            <h3 class="text-xl font-bold mb-4 text-center text-gray-800" id="modal-title">è¿›è¡Œæ‰“å¡</h3>
            <input type="hidden" id="current-task-id">
            
            <div class="mb-4 border-2 border-dashed border-[#a5d6a7] rounded-xl p-4 text-center bg-[#f1f8e9]">
                <label for="photo-upload" class="cursor-pointer block">
                    <div class="text-[#4caf50] mb-2 text-3xl">ğŸ“·</div>
                    <p class="text-sm text-gray-600 font-medium">ç‚¹å‡»æ‹æ‘„æˆ–ä¸Šä¼ ç…§ç‰‡</p>
                    <input type="file" id="photo-upload" accept="image/*" class="hidden" onchange="previewImage(event)"/>
                </label>
                <img id="image-preview" class="hidden mt-3 rounded-lg max-h-32 mx-auto object-cover" />
            </div>

            <div class="mb-6">
                <textarea id="checkin-note" rows="2" class="w-full bg-[#f8faf8] border border-gray-200 rounded-lg p-3 text-sm focus:outline-none focus:ring-2 focus:ring-[#4caf50]" placeholder="å†™ç‚¹æ‰“å¡å¿ƒå¾—å§ï¼ˆä¾‹å¦‚ï¼šå·²ç»å®Œæˆä½œä¸šå•¦ï¼ï¼‰"></textarea>
            </div>

            <div class="flex gap-3">
                <button onclick="closeModal()" class="flex-1 py-3 bg-gray-100 text-gray-600 rounded-full font-bold hover:bg-gray-200">å–æ¶ˆ</button>
                <button id="submit-btn" onclick="submitCheckIn()" class="flex-1 py-3 bg-[#4caf50] text-white rounded-full font-bold hover:bg-[#43a047]">ç¡®è®¤æ‰“å¡</button>
            </div>
        </div>
    </div>

    <script>
        // --- æ ¸å¿ƒæ•°æ®ç»“æ„ ---
        const DAYS_MAP =[
            { label: 'ä¸€', value: 1 }, { label: 'äºŒ', value: 2 }, 
            { label: 'ä¸‰', value: 3 }, { label: 'å››', value: 4 }, 
            { label: 'äº”', value: 5 }, { label: 'å…­', value: 6 }, 
            { label: 'æ—¥', value: 0 }
        ];
        
        let selectedDays =[1, 2, 3, 4, 5, 6, 0]; 
        let tasks =[];
        let records =[];
        
        let viewDateObj = new Date();        
        let historyDateObj = new Date();     

        function getStrFromDate(d) {
            return d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
        }

        // --- 0. å¼‚æ­¥æ•°æ®åº“åˆå§‹åŒ–ä¸æ•°æ®è¿ç§» ---
        async function initData() {
            try {
                let lfTasks = await localforage.getItem('habitTasks');
                let lfRecords = await localforage.getItem('habitRecords');

                let oldTasks = localStorage.getItem('habitTasks');
                let oldRecords = localStorage.getItem('habitRecords');

                if (!lfTasks && oldTasks) {
                    tasks = JSON.parse(oldTasks);
                    await localforage.setItem('habitTasks', tasks);
                    localStorage.removeItem('habitTasks'); 
                } else {
                    tasks = lfTasks ||[];
                }

                if (!lfRecords && oldRecords) {
                    records = JSON.parse(oldRecords);
                    await localforage.setItem('habitRecords', records);
                    localStorage.removeItem('habitRecords'); 
                } else {
                    records = lfRecords ||[];
                }

                document.getElementById('loading-screen').classList.add('hidden');
                initUI();

            } catch (err) {
                console.error('æ•°æ®åº“åˆå§‹åŒ–å¤±è´¥:', err);
                alert('æ•°æ®åº“åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•ï¼');
            }
        }

        // --- 1. åˆå§‹åŒ–é¡µé¢ UI ---
        function initUI() {
            document.getElementById('header-date').innerText = new Date().toLocaleDateString('zh-CN', {month: 'long', day: 'numeric'});
            document.getElementById('start-date').value = getStrFromDate(new Date());

            const container = document.getElementById('week-days-container');
            container.innerHTML = '';
            DAYS_MAP.forEach(day => {
                const isSelected = selectedDays.includes(day.value);
                const btn = document.createElement('div');
                btn.className = `day-btn w-9 h-9 flex items-center justify-center rounded-full text-sm font-bold cursor-pointer ${isSelected ? 'bg-[#a5d6a7] text-[#1b5e20]' : 'bg-gray-100 text-gray-400'}`;
                btn.innerText = day.label;
                btn.onclick = () => toggleDay(day.value, btn);
                container.appendChild(btn);
            });

            renderTasks();
            renderRecords();
        }

        function toggleDay(dayValue, btnElement) {
            if (selectedDays.includes(dayValue)) {
                if (selectedDays.length === 1) return alert('è‡³å°‘éœ€è¦é€‰æ‹©ä¸€å¤©æ‰“å¡å“¦ï¼');
                selectedDays = selectedDays.filter(d => d !== dayValue);
                btnElement.className = 'day-btn w-9 h-9 flex items-center justify-center rounded-full text-sm font-bold cursor-pointer bg-gray-100 text-gray-400';
            } else {
                selectedDays.push(dayValue);
                btnElement.className = 'day-btn w-9 h-9 flex items-center justify-center rounded-full text-sm font-bold cursor-pointer bg-[#a5d6a7] text-[#1b5e20]';
            }
        }

        function createTask() {
            const name = document.getElementById('task-name').value.trim();
            const startDate = document.getElementById('start-date').value;

            if (!name) return alert('è¯·è¾“å…¥ä¹ æƒ¯åç§°ï¼');
            if (selectedDays.length === 0) return alert('è¯·é€‰æ‹©æ‰“å¡å‘¨æœŸï¼');

            const newTask = {
                id: 'task_' + Date.now(),
                name: name,
                cycleDays:[...selectedDays],
                startDate: startDate,
                createTime: new Date().getTime()
            };

            tasks.push(newTask);
            localforage.setItem('habitTasks', tasks); 
            
            document.getElementById('task-name').value = '';
            alert('ä¹ æƒ¯åˆ›å»ºæˆåŠŸï¼');
            renderTasks();
        }

        function changeDate(offset) {
            viewDateObj.setDate(viewDateObj.getDate() + offset);
            renderTasks();
        }

        function changeHistoryDate(offset) {
            historyDateObj.setDate(historyDateObj.getDate() + offset);
            renderRecords();
        }

        // --- 4. æ¸²æŸ“ä»»åŠ¡åˆ—è¡¨ ---
        function renderTasks() {
            const listDiv = document.getElementById('today-tasks-list');
            listDiv.innerHTML = '';

            const todayStr = getStrFromDate(new Date());
            const viewDateStr = getStrFromDate(viewDateObj);
            const viewDayOfWeek = viewDateObj.getDay();

            const titleEl = document.getElementById('view-date-title');
            const subTitleEl = document.getElementById('view-date-subtitle');
            subTitleEl.textContent = viewDateStr;
            
            const yesterdayDate = new Date();
            yesterdayDate.setDate(yesterdayDate.getDate() - 1);
            if (viewDateStr === todayStr) {
                titleEl.textContent = 'ä»Šæ—¥å¾…åŠ';
            } else if (viewDateStr === getStrFromDate(yesterdayDate)) {
                titleEl.textContent = 'æ˜¨æ—¥å¾…åŠ';
            } else {
                titleEl.textContent = `${viewDateObj.getMonth()+1}æœˆ${viewDateObj.getDate()}æ—¥ å¾…åŠ`;
            }

            const todaysTasks = tasks.filter(task => {
                const hasStarted = task.startDate <= viewDateStr;
                const isScheduledToday = task.cycleDays.includes(viewDayOfWeek);
                return hasStarted && isScheduledToday;
            });

            if (todaysTasks.length === 0) {
                listDiv.innerHTML = '<div class="text-center p-6 bg-gray-50 rounded-xl text-gray-400 text-sm border border-dashed border-gray-200">è¿™ä¸€å¤©æ²¡æœ‰ä»»ä½•æ‰“å¡ä»»åŠ¡å“¦~</div>';
                return;
            }

            todaysTasks.forEach(task => {
                const hasCheckedIn = records.some(r => r.taskId === task.id && r.date === viewDateStr);

                let buttonHtml = '';
                const isFuture = viewDateStr > todayStr;
                const isPast = viewDateStr < todayStr;

                if (hasCheckedIn) {
                    buttonHtml = `<button disabled class="bg-gray-100 text-gray-400 px-4 py-2 rounded-full text-sm font-bold flex items-center gap-1"><span>âœ…</span> å·²å®Œæˆ</button>`;
                } else {
                    if (isFuture) {
                        buttonHtml = `<button disabled class="bg-gray-100 text-gray-400 px-4 py-2 rounded-full text-sm font-bold">â³ æœªå¼€å§‹</button>`;
                    } else if (isPast) {
                        buttonHtml = `<button onclick="openModal('${task.id}', '${task.name}')" class="bg-orange-100 text-orange-600 px-4 py-2 rounded-full text-sm font-bold hover:bg-orange-200">âš ï¸ è¡¥å¡</button>`;
                    } else {
                        buttonHtml = `<button onclick="openModal('${task.id}', '${task.name}')" class="bg-[#eaf5ec] text-[#2e7d32] px-4 py-2 rounded-full text-sm font-bold hover:bg-[#c8e6c9] transition-colors shadow-sm">ğŸ¯ å»æ‰“å¡</button>`;
                    }
                }

                const div = document.createElement('div');
                div.className = 'relative overflow-hidden rounded-xl bg-red-500'; 
                div.innerHTML = `
                    <div class="absolute inset-y-0 right-0 w-24 flex items-center justify-end pr-4 text-white font-bold cursor-pointer" onclick="deleteTask('${task.id}')">
                        åˆ é™¤ ğŸ—‘ï¸
                    </div>
                    <div class="task-card relative bg-white p-4 flex justify-between items-center rounded-xl shadow-sm border border-gray-100 z-10 transition-transform duration-300">
                        <div class="flex items-center gap-3 pointer-events-none">
                            <div class="w-10 h-10 bg-[#f1f8e9] rounded-full flex items-center justify-center text-xl">ğŸ¯</div>
                            <div>
                                <p class="font-bold text-gray-800 text-base">${task.name}</p>
                                <p class="text-xs text-gray-400 mt-0.5">â¬…ï¸ å·¦æ»‘å¯åˆ é™¤è¯¥ä¹ æƒ¯</p>
                            </div>
                        </div>
                        ${buttonHtml}
                    </div>
                `;
                listDiv.appendChild(div);
            });

            attachSwipeListeners();
        }

        function attachSwipeListeners() {
            const cards = document.querySelectorAll('.task-card');
            cards.forEach(card => {
                let isDragging = false;
                let startX = 0;
                let currentX = 0;

                const startDrag = (e) => {
                    isDragging = true;
                    startX = e.type.includes('mouse') ? e.pageX : e.touches[0].clientX;
                    card.style.transition = 'none'; 
                };

                const moveDrag = (e) => {
                    if (!isDragging) return;
                    const x = e.type.includes('mouse') ? e.pageX : e.touches[0].clientX;
                    currentX = x - startX;
                    if (currentX < 0) {
                        const moveX = Math.max(currentX, -90); 
                        card.style.transform = `translateX(${moveX}px)`;
                    }
                };

                const endDrag = (e) => {
                    if (!isDragging) return;
                    isDragging = false;
                    card.style.transition = 'transform 0.3s ease'; 
                    if (currentX < -45) {
                        card.style.transform = `translateX(-80px)`;
                    } else {
                        card.style.transform = `translateX(0px)`;
                    }
                    currentX = 0;
                };

                card.addEventListener('touchstart', startDrag, {passive: true});
                card.addEventListener('touchmove', moveDrag, {passive: true});
                card.addEventListener('touchend', endDrag);

                card.addEventListener('mousedown', startDrag);
                card.addEventListener('mousemove', moveDrag);
                card.addEventListener('mouseup', endDrag);
                card.addEventListener('mouseleave', endDrag);
            });
        }

        function deleteTask(taskId) {
            if(confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªä¹ æƒ¯å—ï¼Ÿåˆ é™¤åæœªæ¥å°†ä¸å†å‡ºç°ã€‚')) {
                tasks = tasks.filter(t => t.id !== taskId);
                localforage.setItem('habitTasks', tasks); 
                renderTasks();
            }
        }

        // --- æ¸…ç©ºæ‰€æœ‰æ•°æ®çš„æµ‹è¯•å·¥å…· ---
        function clearAllData() {
            if(confirm('âš ï¸ å±é™©æ“ä½œï¼šä½œä¸ºäº§å“ç»ç†æµ‹è¯•ï¼Œä½ ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰çš„ä¹ æƒ¯å’Œæ‰“å¡è®°å½•å—ï¼Ÿæ¸…ç©ºåå°†æ— æ³•æ¢å¤ï¼')) {
                localforage.clear().then(() => {
                    localStorage.clear(); 
                    alert('æ•°æ®å·²å…¨éƒ¨æ¸…ç©ºï¼å³å°†åˆ·æ–°é¡µé¢ã€‚');
                    location.reload();
                });
            }
        }

        // --- 5. å¼¹çª—ä¸ç…§ç‰‡é¢„è§ˆ ---
        function openModal(taskId, taskName) {
            document.getElementById('current-task-id').value = taskId;
            const isPast = getStrFromDate(viewDateObj) < getStrFromDate(new Date());
            document.getElementById('modal-title').textContent = isPast ? `è¡¥å¡: ${taskName}` : `æ‰“å¡: ${taskName}`;
            
            document.getElementById('photo-upload').value = ''; 
            document.getElementById('image-preview').classList.add('hidden');
            document.getElementById('image-preview').src = '';
            document.getElementById('checkin-note').value = ''; 
            
            const btn = document.getElementById('submit-btn');
            btn.textContent = 'ç¡®è®¤æ‰“å¡';
            btn.disabled = false;
            btn.className = 'flex-1 py-3 bg-[#4caf50] text-white rounded-full font-bold hover:bg-[#43a047]';

            document.getElementById('checkin-modal').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('checkin-modal').classList.add('hidden');
        }

        function previewImage(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = document.getElementById('image-preview');
                    img.src = e.target.result;
                    img.classList.remove('hidden');
                }
                reader.readAsDataURL(file);
            }
        }

        // å‰ç«¯å›¾ç‰‡å‹ç¼©ç®—æ³•
        function compressImage(file, callback) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');

                    const MAX_WIDTH = 800;
                    const MAX_HEIGHT = 800;
                    let width = img.width;
                    let height = img.height;

                    if (width > height) {
                        if (width > MAX_WIDTH) {
                            height *= MAX_WIDTH / width;
                            width = MAX_WIDTH;
                        }
                    } else {
                        if (height > MAX_HEIGHT) {
                            width *= MAX_HEIGHT / height;
                            height = MAX_HEIGHT;
                        }
                    }

                    canvas.width = width;
                    canvas.height = height;

                    ctx.fillStyle = '#fff';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(img, 0, 0, width, height);

                    const compressedBase64 = canvas.toDataURL('image/jpeg', 0.6);
                    callback(compressedBase64);
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        // --- 6. æäº¤æ‰“å¡ ---
        function submitCheckIn() {
            const taskId = document.getElementById('current-task-id').value;
            const fileInput = document.getElementById('photo-upload');
            const file = fileInput.files[0];
            const note = document.getElementById('checkin-note').value.trim();

            if (!file && !note) {
                return alert('è¯·è‡³å°‘ä¸Šä¼ ä¸€å¼ ç…§ç‰‡æˆ–å†™ä¸€å¥å¿ƒå¾—å“¦ï¼');
            }

            const btn = document.getElementById('submit-btn');
            btn.textContent = 'ä¿å­˜ä¸­...';
            btn.disabled = true;
            btn.className = 'flex-1 py-3 bg-gray-400 text-white rounded-full font-bold';

            const saveRecord = (imageBase64) => {
                const task = tasks.find(t => t.id === taskId);
                const checkInDateStr = getStrFromDate(viewDateObj);
                
                const newRecord = {
                    id: 'rec_' + Date.now(),
                    taskId: taskId,
                    taskName: task.name,
                    date: checkInDateStr,
                    time: new Date().toLocaleTimeString('zh-CN', { hour12: false }),
                    image: imageBase64, 
                    note: note          
                };

                records.unshift(newRecord); 
                
                localforage.setItem('habitRecords', records).then(() => {
                    closeModal();
                    historyDateObj = new Date(viewDateObj);
                    renderTasks(); 
                    renderRecords();
                }).catch((error) => {
                    console.error(error);
                    alert('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•ï¼');
                    records.shift(); 
                    btn.textContent = 'ç¡®è®¤æ‰“å¡';
                    btn.disabled = false;
                    btn.className = 'flex-1 py-3 bg-[#4caf50] text-white rounded-full font-bold hover:bg-[#43a047]';
                });
            };

            if (file) {
                compressImage(file, function(compressedResult) {
                    saveRecord(compressedResult);
                });
            } else {
                saveRecord(null);
            }
        }

        // --- ã€æ–°å¢åŠŸèƒ½ã€‘åˆ é™¤ç‰¹å®šæ‰“å¡è®°å½• ---
        function deleteRecord(recordId) {
            if(confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡æ‰“å¡è®°å½•å—ï¼Ÿåˆ é™¤åä¸å¯æ¢å¤å“¦ï¼')) {
                // 1. ä»æ•°ç»„ä¸­è¿‡æ»¤æ‰è¦åˆ é™¤çš„è®°å½•
                records = records.filter(r => r.id !== recordId);
                
                // 2. æ›´æ–°åˆ°æ•°æ®åº“
                localforage.setItem('habitRecords', records).then(() => {
                    // 3. é‡æ–°æ¸²æŸ“è®°å½•å¢™
                    renderRecords();
                    // 4. é‡æ–°æ¸²æŸ“å¾…åŠåˆ—è¡¨ï¼ˆå¦‚æœåˆ é™¤äº†ä»Šå¤©çš„è®°å½•ï¼Œå¾…åŠåˆ—è¡¨ä¼šè‡ªåŠ¨å˜æˆâ€œå»æ‰“å¡â€çŠ¶æ€ï¼‰
                    renderTasks();
                }).catch(err => {
                    console.error('åˆ é™¤å¤±è´¥:', err);
                    alert('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•ï¼');
                });
            }
        }

        // --- 7. æ¸²æŸ“æ‰“å¡ç…§ç‰‡å¢™ ---
        function renderRecords() {
            const historyListDiv = document.getElementById('history-list');
            historyListDiv.innerHTML = '';

            const todayStr = getStrFromDate(new Date());
            const viewHistoryStr = getStrFromDate(historyDateObj);

            const titleEl = document.getElementById('history-date-title');
            const subTitleEl = document.getElementById('history-date-subtitle');
            subTitleEl.textContent = viewHistoryStr;
            
            const yesterdayDate = new Date();
            yesterdayDate.setDate(yesterdayDate.getDate() - 1);
            if (viewHistoryStr === todayStr) {
                titleEl.textContent = 'ä»Šæ—¥è®°å½•å¢™';
            } else if (viewHistoryStr === getStrFromDate(yesterdayDate)) {
                titleEl.textContent = 'æ˜¨æ—¥è®°å½•å¢™';
            } else {
                titleEl.textContent = `${historyDateObj.getMonth()+1}æœˆ${historyDateObj.getDate()}æ—¥ è®°å½•`;
            }

            const dailyRecords = records.filter(r => r.date === viewHistoryStr);

            if (dailyRecords.length === 0) {
                historyListDiv.innerHTML = `<p class="text-gray-400 text-sm col-span-2 text-center py-6 bg-gray-50 rounded-xl border border-dashed border-gray-200">è¿™ä¸€å¤©è¿˜æ²¡æœ‰ç•™ä¸‹è¶³è¿¹å“¦~</p>`;
                return;
            }

            dailyRecords.forEach(record => {
                const div = document.createElement('div');
                div.className = 'bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden flex flex-col relative';
                
                let imageHtml = '';
                if (record.image) {
                    imageHtml = `<img src="${record.image}" class="w-full h-32 object-cover">`;
                } else {
                    imageHtml = `<div class="w-full h-24 bg-[#eaf5ec] flex items-center justify-center text-3xl">ğŸ“</div>`;
                }

                let noteHtml = '';
                if (record.note) {
                    noteHtml = `<div class="px-3 py-2 text-xs text-gray-600 border-b border-gray-50 italic">"${record.note}"</div>`;
                }

                div.innerHTML = `
                    <div class="relative overflow-hidden bg-gray-200">
                        ${imageHtml}
                        <!-- ã€æ–°å¢ã€‘åˆ é™¤è®°å½•çš„åƒåœ¾æ¡¶å°æŒ‰é’® -->
                        <button onclick="deleteRecord('${record.id}')" class="absolute top-2 right-2 bg-black/40 hover:bg-red-500 text-white w-7 h-7 rounded-full flex items-center justify-center text-xs backdrop-blur-sm transition-colors z-10 opacity-80 hover:opacity-100 shadow-sm" title="åˆ é™¤è¯¥è®°å½•">
                            ğŸ—‘ï¸
                        </button>
                        <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/60 to-transparent p-2 text-white pointer-events-none">
                            <p class="text-xs font-bold drop-shadow-md">${record.taskName}</p>
                        </div>
                    </div>
                    ${noteHtml}
                    <div class="p-2 flex justify-between items-center bg-[#fafafa] mt-auto">
                        <span class="text-[10px] text-gray-400">âœ… ${record.date}</span>
                        <span class="text-[10px] text-gray-400">${record.time}</span>
                    </div>
                `;
                historyListDiv.appendChild(div);
            });
        }

        // --- å¯åŠ¨åº”ç”¨ ---
        window.onload = initData;
    </script>
</body>
</html>